%this function calculates scale invariant harris corner points by comparing
%the laplacian of a value to the laplacians of all neighbours in a 3x3
%window in all scale levels

%INPUT: im is path of image of which to find scale invariant feature points
%OUTPUT: row and column indices of feature points in the image

function inv_feat = invFeatures(im)

sigmas = 1.2.^[0:12];

%get size of the image
imC = imread(im);
imC = im2double(imC);

if size(imC,3) == 3
    imC = rgb2gray(imC); 
end

[im_y,im_x]=size(imC);

%lapl is a tensor of size ( size_y(img) x size_x(img) x size(sigmas))
%at each position in a level it has the value of the 2D Laplacian gaussian
lapl = zeros(im_y, im_x, size(sigmas,2));

%laplmax is a tensor of size ( size_y(img) x size_x(img) x size(sigmas))
%at each level it includes the maximum value in a 3x3 window
laplmax = zeros(im_y, im_x, size(sigmas,2));

for i = 1:size(sigmas,2)
    
    Lx = ImageDerivatives(im,sigmas(i),'xx','');
    Ly = ImageDerivatives(im,sigmas(i),'yy',''); 
    
    L = Lx + Ly; 
    
    size(L)
    
    %calculate 
    lapl(:,:,i) = L;
    
    %find maximum in 3x3 window at the level by first computing movmax
    %for each row and then for each column
    
    L_rowmax = movmax(L,3,2);
    L_max = movmax(L_rowmax,3,1);
    
    laplmax(:,:,i) = L_max;
    
end

%inv_feat contains the final scale invariant feature points
inv_feat = [];
%discardedpoints keeps track of how many feature points where discarded for
%informative reasons
discardedpoints = 0;

%now get the feature points for each sigma level and only keep those
%feature points where the value of the laplacian is higher than the local
%maximum in all levels

for i = 1:size(sigmas,2)
    
    [r,c] = harris(im,sigmas(i));
    
    s = size(r);
    
    for p = 1:s(1) 
        
        %look up lapl value and compare it to the max over all values
        if lapl(r(p),c(p),i) >= max(laplmax(:,:,i))
            %add point to final points
            fprintf('here')
            inv_feat = cat(1,inv_feat,[r(p),c(p)]);
        else 
            discardedpoints = discardedpoints + 1;
        end
        
    end
    
end

fprintf("Number of discarded feature points: %d",discardedpoints);

end